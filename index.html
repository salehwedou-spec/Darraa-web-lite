<!doctype html>
<html lang="ar" dir="rtl">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>متجر الدراعة | طلب سريع</title>
<style>
  :root{
    --bg:#f6f9ff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
    --card:#ffffff; --blue:#e7f0fb; --blue-ink:#0d3b66; --gold:#c89a2b; --gold-700:#a67e1f;
    --shadow: 0 10px 30px rgba(13,59,102,.06), 0 2px 10px rgba(0,0,0,.04); --r:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--blue) 0%, #eef5ff 30%, var(--bg) 100%);color:var(--ink);
       font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Arabic","Noto Naskh Arabic",sans-serif}
  .shell{max-width:1100px;margin:auto;padding:16px}
  header{background:#fff;border:1px solid var(--line);border-radius:20px;padding:10px 14px;display:flex;align-items:center;gap:12px;box-shadow:var(--shadow)}
  .brand{display:flex;align-items:center;gap:10px}
  .mark{width:40px;height:40px;border-radius:12px;background: radial-gradient(circle at 30% 30%, #fbe8b4, var(--gold));
        border:2px solid var(--gold-700);box-shadow:inset 0 0 0 2px rgba(255,255,255,.4)}
  .nav{margin-inline-start:auto;display:flex;gap:10px;align-items:center}
  .pill{padding:.55rem .9rem;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600}
  .pill.gold{border-color:var(--gold);background:var(--gold);color:#fff}

  .hero{margin-top:14px;border-radius:24px;background:
        radial-gradient(120% 140% at 100% 0%, rgba(200,154,43,.12), transparent 40%),
        radial-gradient(120% 140% at 0% 0%, rgba(13,59,102,.10), transparent 45%),
        #ffffff; border:1px solid var(--line); padding:20px; box-shadow:var(--shadow)}
  .hero .row{display:grid;gap:16px}
  @media(min-width:900px){ .hero .row{grid-template-columns: 1.1fr .9fr} }
  .hero h1{margin:0 0 6px 0;font-size:28px;color:var(--blue-ink)}
  .hero p{margin:0;color:var(--muted)}
  .swatch{display:flex;gap:6px;margin-top:10px}
  .dot{width:26px;height:26px;border-radius:999px;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.15)}
  .mock{border-radius:18px;min-height:200px;background:
        linear-gradient(160deg,#e7f0fb,#dbe9ff 60%, #fff 100%);
        border:1px dashed rgba(200,154,43,.4); position:relative}

  .section{margin-top:18px}
  .title{font-weight:800;color:var(--blue-ink);margin:0 0 10px 0}
  .grid{display:grid;gap:14px}
  @media(min-width:700px){ .grid{grid-template-columns: repeat(3, 1fr)} }
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:12px;display:flex;flex-direction:column;gap:10px}
  .thumb{border-radius:14px;aspect-ratio: 4/3;background:#eef5ff;border:1px dashed rgba(200,154,43,.35);overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .price{font-weight:800}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .mini{font-size:12px;color:var(--muted)}
  .color-dot{width:20px;height:20px;border-radius:999px;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.15);cursor:pointer}
  .color-dot.active{box-shadow:0 0 0 2px var(--gold)}
  .buy{display:flex;gap:8px;margin-top:auto}
  .btn{padding:.6rem .9rem;border-radius:12px;border:1px solid var(--gold);background:var(--gold);color:#fff;font-weight:700;cursor:pointer}
  .btn.secondary{background:#fff;color:var(--ink);border-color:var(--line)}

  .drawer{position:fixed;inset:0;display:none}
  .drawer.show{display:block}
  .shade{position:absolute;inset:0;background:rgba(0,0,0,.25)}
  .panel{position:absolute;inset-block:0;left:0;width:min(92vw,420px);background:#fff;border-right:1px solid var(--line);
         padding:16px;display:flex;flex-direction:column;gap:10px}
  .cart-item{display:flex;gap:10px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:10px}
  .hr{height:1px;background:var(--line);margin:8px 0}
  .total{display:flex;justify-content:space-between;font-weight:800}
  .paybox{display:grid;gap:10px;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fafcff}
</style>

<body>
  <div class="shell">
    <header>
      <div class="brand">
        <div class="mark"></div>
        <div>
          <div style="font-weight:800;color:var(--blue-ink)">متجر الدراعة</div>
          <div class="mini">اختيار الطريز والقماش والنقش ثم الدفع</div>
        </div>
      </div>
      <div class="nav">
        <button class="pill gold" id="openCart">سلة الشراء</button>
      </div>
    </header>

    <section class="hero">
      <div class="row">
        <div>
          <h1>دراعة موريتانية رجالية</h1>
          <p>ألوان واقعية وخنط ذهبي، مع أفضل أنواع الأقمشة.</p>
          <div class="swatch">
            <div class="dot" style="background:#e7f0fb"></div>
            <div class="dot" style="background:#ffffff"></div>
            <div class="dot" style="background:#c89a2b"></div>
          </div>
        </div>
        <div class="mock"></div>
      </div>
    </section>

    <section class="section">
      <h2 class="title">الطريزات المتوفرة</h2>
      <div id="grid" class="grid"></div>
    </section>
  </div>

  <div class="drawer" id="drawer">
    <div class="shade" id="closeDrawer"></div>
    <aside class="panel">
      <button class="pill" id="closeX" style="margin-inline-start:auto">إغلاق</button>
      <div id="cartBox"></div>
      <div class="hr"></div>
      <div class="total"><div>الإجمالي</div><div id="totalTxt">0</div></div>

      <div class="paybox">
        <div class="mini">اختر وسيلة الدفع:</div>
        <label><input type="radio" name="pay" value="bankily" checked> Bankily</label>
        <label><input type="radio" name="pay" value="sedad"> Sedad</label>
        <label><input type="radio" name="pay" value="masrvi"> Masrvi</label>
        <button class="btn" id="checkoutBtn">ادفع الآن</button>
        <div class="mini" id="status">الحالة: -</div>
        <input id="base" type="text" style="width:100%" value="https://darraa-pay-backend.onrender.com">
      </div>
    </aside>
  </div>

<script>
/* الصور التي رفعتها بأسمائها الحالية */
const DESIGNS = [
  { id:"dz1", title:"طريز كلاسيكي", price:28000, colors:["#e7f0fb","#ffffff","#c89a2b"], img:"images/images (1) (1).jpeg" },
  { id:"dz2", title:"طريز عصري",    price:32000, colors:["#d9e8ff","#ffffff","#c89a2b"], img:"images/images (14).jpeg" },
  { id:"dz3", title:"طريز رسمي",    price:40000, colors:["#cfe0ff","#ffffff","#c89a2b"], img:"images/images (15).jpeg" },
];
/* أنواع القماش */
const FABRICS = [
  { id:"azbi",     name:"أزبي",      extra:0,    colors:["#e7f0fb","#ffffff","#bcd3ff"] },
  { id:"fasniger", name:"فسنيجر",    extra:3000, colors:["#dbe8ff","#ffffff","#a6b7d3"] },
  { id:"gaznir",   name:"جازنير",    extra:5000, colors:["#cfe0ff","#ffffff","#90b7ff"] },
  { id:"jamani",   name:"جماني",     extra:7000, colors:["#cfe6ff","#ffffff","#9fb9ff"] },
  { id:"shagah",   name:"الشگة",     extra:4000, colors:["#e3edff","#ffffff","#c9d6f3"] },
  { id:"sandasiya",name:"صاندسيه",   extra:6000, colors:["#dae6ff","#ffffff","#b5c7ea"] },
  { id:"osaka",    name:"اوزاكا",    extra:9000, colors:["#c8dcff","#ffffff","#a6b7d3"] },
];
/* النقوش */
const PATTERNS = [
  { id:"betiba",   name:"بتيبا",   extra:0    },
  { id:"khmini",   name:"الخميني", extra:1000 },
  { id:"afir",     name:"افير",    extra:2000 },
  { id:"dollar",   name:"الدولار", extra:3000 },
  { id:"muqaddam", name:"المقدم",  extra:4000 },
];
const BASE_SEWING = 2000;

let cart = [];
const $ = q=>document.querySelector(q);
const fmt = n=> (n||0).toLocaleString("ar-MR");

function renderProducts(){
  const g = $("#grid"); g.innerHTML="";
  DESIGNS.forEach(d=>{
    const card = document.createElement("div"); card.className="card";
    const thumb = document.createElement("div"); thumb.className="thumb";
    /* عرض الصورة كـ <img> لضمان عمل أسماء تحتوي مسافات وأقواس */
    const img = document.createElement("img");
    img.src = d.img; img.alt = d.title; thumb.appendChild(img);

    const title = document.createElement("div"); title.style.fontWeight="800"; title.textContent=d.title;
    const price = document.createElement("div"); price.className="price"; price.textContent = fmt(d.price) + " أوقية";

    const colors = document.createElement("div"); colors.className="row";
    d.colors.forEach(hex=>{
      const dot = document.createElement("div"); dot.className="color-dot"; dot.style.background=hex;
      dot.onclick = ()=>{ [...colors.children].forEach(c=>c.classList.remove("active")); dot.classList.add("active"); };
      colors.appendChild(dot);
    });
    colors.firstChild?.classList.add("active");

    // القماش + النقش
    const fabricRow = document.createElement("div"); fabricRow.className="row";
    const selFabric = document.createElement("select");
    FABRICS.forEach(f=>{
      const op = document.createElement("option");
      op.value=f.id; op.textContent=`${f.name} (+${fmt(f.extra)})`;
      selFabric.appendChild(op);
    });
    const selPattern = document.createElement("select");
    PATTERNS.forEach(p=>{
      const op = document.createElement("option");
      op.value=p.id; op.textContent=`${p.name} (+${fmt(p.extra)})`;
      selPattern.appendChild(op);
    });
    fabricRow.append("القماش:", selFabric, "النقش:", selPattern);

    const actions = document.createElement("div"); actions.className="buy";
    const add = document.createElement("button"); add.className="btn"; add.textContent="أضف للسلة";
    add.onclick = ()=>{
      const color = [...colors.children].find(c=>c.classList.contains("active"))?.style.background || d.colors[0];
      const f = FABRICS.find(x=>x.id === selFabric.value) || FABRICS[0];
      const p = PATTERNS.find(x=>x.id === selPattern.value) || PATTERNS[0];
      cart.push({
        id: d.id+"-"+Date.now(),
        title: d.title,
        designPrice: d.price,
        fabricId: f.id,   fabricName: f.name,   fabricExtra: f.extra,
        patternId: p.id,  patternName: p.name,  patternExtra: p.extra,
        color, img: d.img
      });
      openDrawer();
      drawCart();
    };
    actions.append(add);

    card.append(thumb, title, price, colors, fabricRow, actions);
    g.append(card);
  });
}

function openDrawer(){ $("#drawer").classList.add("show"); }
function closeDrawer(){ $("#drawer").classList.remove("show"); }
$("#openCart").onclick=openDrawer; $("#closeDrawer").onclick=closeDrawer; $("#closeX").onclick=closeDrawer;

function drawCart(){
  const box = $("#cartBox"); box.innerHTML="";
  if(!cart.length){ box.innerHTML='<div class="mini">السلة فارغة.</div>'; $("#totalTxt").textContent="0"; return; }
  let total = 0;
  cart.forEach(item=>{
    const line = document.createElement("div"); line.className="cart-item";
    const sw = document.createElement("img"); sw.src=item.img; sw.alt=""; sw.style.width="54px"; sw.style.height="54px"; sw.style.objectFit="cover"; sw.style.borderRadius="8px"; sw.style.border="1px solid var(--line)";
    const info = document.createElement("div");
    info.innerHTML = `<div style="font-weight:700">${item.title}</div>
                      <div class="mini">${item.fabricName} (+${fmt(item.fabricExtra)}) • نقش: ${item.patternName} (+${fmt(item.patternExtra)})</div>`;
    const sum = item.designPrice + item.fabricExtra + item.patternExtra + BASE_SEWING; total += sum;
    const price = document.createElement("div"); price.style.marginInlineStart="auto"; price.innerHTML = `<b>${fmt(sum)}</b>`;
    const del = document.createElement("button"); del.className="pill"; del.textContent="حذف";
    del.onclick = ()=>{ cart = cart.filter(x=>x.id!==item.id); drawCart(); };
    line.append(sw, info, price, del);
    box.append(line);
  });
  $("#totalTxt").textContent = fmt(total) + " أوقية";
}

async function checkout(){
  if(!cart.length) return alert("السلة فارغة");
  const provider = document.querySelector('input[name="pay"]:checked').value;
  const BASE = $("#base").value.trim();
  const total = cart.reduce((s,i)=> s + i.designPrice + i.fabricExtra + i.patternExtra + BASE_SEWING, 0);
  const meta = { items: cart };

  $("#status").textContent = "الحالة: جاري إنشاء عملية الدفع…";
  try{
    const r = await fetch(BASE + "/payments/create",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ orderId:null, amountMRU: total, provider, meta })
    });
    const data = await r.json();
    if(!data?.paymentId) throw new Error("تعذر الإنشاء");
    $("#status").textContent = "تم الإنشاء. المرجع: "+data.merchantRef;
    alert("افتح تطبيق "+provider+" وأكمل الدفع بالمرجع: "+data.merchantRef);
  }catch(e){
    $("#status").textContent = "فشل الإنشاء";
    alert("خطأ في إنشاء الدفع");
  }
}
$("#checkoutBtn").onclick = checkout;

renderProducts();
drawCart();
</script>
</body>
</html>
