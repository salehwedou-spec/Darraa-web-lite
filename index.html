<!doctype html>
<html lang="ar" dir="rtl">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>طلب الدراعة – تجربة الدفع</title>
<style>
  :root{
    --bg:#f7fafc;              /* خلفية عامة */
    --card:#ffffff;            /* بطاقات */
    --ink:#0f172a;             /* نص رئيسي */
    --muted:#64748b;           /* نص ثانوي */
    --blue:#e7f0fb;            /* أزرق قماش فاتح */
    --blue-ink:#0d3b66;        /* أزرق غامق للنص */
    --gold:#c89a2b;            /* ذهبي خنط */
    --gold-700:#a67e1f;
    --line:#e2e8f0;
    --shadow: 0 10px 30px rgba(13,59,102,.06), 0 2px 10px rgba(0,0,0,.04);
    --radius:18px;
  }
  
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--blue) 0%, #eef5ff 30%, var(--bg) 100%);color:var(--ink);
       font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Arabic","Noto Naskh Arabic",sans-serif;}
  .wrap{max-width:860px;margin:auto;padding:20px}
  header{
    background:linear-gradient(135deg, rgba(200,154,43,.08), rgba(13,59,102,.06));
    border:1px solid var(--line); border-radius:24px; padding:18px 16px; box-shadow: var(--shadow);
    display:flex; align-items:center; gap:12px;
  }
  .brand{
    display:flex; align-items:center; gap:12px;
  }
  .mark{width:42px;height:42px;border-radius:12px; background: radial-gradient(circle at 30% 30%, #fbe8b4, var(--gold));
        border:2px solid var(--gold-700); box-shadow: inset 0 0 0 2px rgba(255,255,255,.4);}
  h1{margin:0;font-size:20px;color:var(--blue-ink)}
  .sub{color:var(--muted);margin-top:4px;font-size:14px}
.pill{border:1px solid var(--line);border-radius:14px;padding:.55rem .8rem;background:#fff;cursor:pointer}
.pill.active{border-color:var(--gold);box-shadow:0 0 0 2px rgba(200,154,43,.15);background:linear-gradient(180deg,#fff,#fff8e6)}
.color-dot{width:26px;height:26px;border-radius:999px;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.12);cursor:pointer}
.color-dot.active{box-shadow:0 0 0 2px var(--gold)}
  .grid{display:grid;gap:14px;margin-top:14px}
  @media(min-width:900px){ .grid{grid-template-columns: 1.2fr 1fr} }

  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .title{font-weight:700;margin:0 0 10px 0;color:var(--blue-ink)}
  label{font-weight:600;font-size:14px;color:var(--ink)}
  input[type="text"]{width:100%;padding:.75rem;border:1px solid var(--line);border-radius:12px;background:#fff}
  select{padding:.6rem .8rem;border:1px solid var(--line);border-radius:12px;background:#fff;min-width:160px}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .btn{padding:.7rem 1.1rem;border-radius:12px;border:1px solid var(--gold);background:var(--gold);color:#fff;
       cursor:pointer;font-weight:700}
  .btn:hover{background:var(--gold-700);border-color:var(--gold-700)}
  .btn.secondary{background:#fff;color:var(--ink);border-color:var(--line)}
  .btn.secondary:hover{background:#f9fafb}
  .meta code{background:#f1f5f9;border:1px solid var(--line);padding:3px 8px;border-radius:8px}
  .log{background:#0b1220;color:#d2e0ff;border-radius:14px;padding:12px;min-height:140px;white-space:pre-wrap;overflow:auto;border:1px solid #10192d}
  .status{color:var(--muted);margin-top:6px}
  .hint{font-size:12px;color:var(--muted)}

  /* شريط علوي يشبه ياقة الدراعة */
  .collar{
    position:relative;border-radius:16px;background:linear-gradient(135deg,#fff, #f6f8fc);
    border:1px dashed rgba(200,154,43,.4);padding:14px;margin-bottom:12px
  }
  .collar:before,.collar:after{
    content:"";position:absolute;top:8px;width:18px;height:54px;border-radius:9px;background:var(--gold);
    box-shadow:inset 0 0 0 3px #f9e7b1
  }
  .collar:before{right:18px}
  .collar:after{right:40px;height:34px;top:28px}
</style>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="mark"></div>
        <div>
          <h1>طلب الدراعة – تجربة الدفع</h1>
          <div class="sub">ألوان واقعية (أزرق فاتح + خنط ذهبي) – تجربة إنشاء عملية دفع والتحقق/المحاكاة</div>
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- العمود الأيسر: الإعداد والتنفيذ -->
      <section class="card">
        <div class="collar"></div>
        
        <h2 class="title">الإعداد</h2>

        <div class="row" style="margin-bottom:10px">
          <div style="flex:1">
            <label>رابط الباكند (Render)</label>
            <input id="base" type="text" value="https://darraa-pay-backend.onrender.com" />
            <div class="hint">يمكنك تغييره هنا متى ما تغيّر رابط Render.</div>
          </div>
        </div>
<!-- ====== (أ) اختيار الطريز ====== -->
<h2 class="title" style="margin-top:18px">اختيار الطريز</h2>
<div id="designs" class="row" style="gap:10px;flex-wrap:wrap"></div>

<!-- ====== (ب) اختيار القماش واللون ====== -->
<h2 class="title" style="margin-top:18px">اختيار القماش واللون</h2>
<div id="fabrics" class="row" style="gap:10px;flex-wrap:wrap"></div>
<div class="hint">الألوان تعبّر عن قماش الدراعة (أزرق فاتح/غامق وأبيض). الذهبي للخنط.</div>

<!-- ====== (ج) القياسات الأساسية ====== -->
<h2 class="title" style="margin-top:18px">القياسات</h2>
<div class="row" style="gap:8px">
  <label>الصدر (سم)</label><input id="m-chest" type="number" style="width:90px;padding:.5rem;border:1px solid #cbd5e1;border-radius:10px">
  <label>الكتف</label><input id="m-shoulder" type="number" style="width:90px;padding:.5rem;border:1px solid #cbd5e1;border-radius:10px">
  <label>طول الكم</label><input id="m-sleeve" type="number" style="width:90px;padding:.5rem;border:1px solid #cbd5e1;border-radius:10px">
  <label>الطول</label><input id="m-length" type="number" style="width:90px;padding:.5rem;border:1px solid #cbd5e1;border-radius:10px">
</div>

<!-- ====== (د) ملخص السعر ====== -->
<div class="card" style="margin-top:14px;background:var(--blue)">
  <h3 class="title" style="font-size:16px">الملخص</h3>
  <div class="row meta">
    <div>سعر الطريز: <code id="price-design">0</code> أوقية</div>
    <div>زيادة القماش: <code id="price-fabric">0</code> أوقية</div>
    <div>خياطة أساسية: <code>2000</code> أوقية</div>
    <div><strong>الإجمالي:</strong> <code id="price-total">0</code> أوقية</div>
  </div>
</div>
        <h2 class="title" style="margin-top:18px">الدفع</h2>
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <label>المزوّد</label>
            <select id="provider">
              <option value="bankily">Bankily</option>
              <option value="sedad">Sedad</option>
              <option value="masrvi">Masrvi</option>
            </select>
          </div>
          <button class="btn" onclick="createPayment()">ادفع الآن</button>
        </div>

        <div class="card" style="margin-top:14px">
          <h3 class="title" style="font-size:16px">معلومات العملية</h3>
          <div class="row meta">
            <div>paymentId: <code id="pid">-</code></div>
            <div>merchantRef: <code id="mref">-</code></div>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" onclick="checkStatus()">تحقق من الحالة</button>
          <button class="btn secondary" onclick="simulate('success')">محاكاة نجاح</button>
          <button class="btn secondary" onclick="simulate('failed')">محاكاة فشل</button>
        </div>
        <div class="status" id="status">الحالة: -</div>
      </section>

      <!-- العمود الأيمن: السجل -->
      <section class="card">
        <h2 class="title">السجل</h2>
        <pre id="log" class="log">جاهز للتجربة…</pre>
      </section>
    </div>
  </div>

  <script>
  // ===== بيانات الطرازات والأقمشة =====
  const DESIGNS = [
    { id:"dz1", title:"طريز صدر كلاسيكي", price:28000 },
    { id:"dz2", title:"طريز حديث مطوّل",   price:32000 },
    { id:"dz3", title:"طريز ثقيل ذهبي",    price:40000 },
  ];
  const FABRICS = [
    { id:"fb1", name:"بزّة خفيفة", extra:0,    colors:["#e7f0fb","#d9e8ff","#ffffff","#bcd3ff"] },
    { id:"fb2", name:"بزّة فاخرة", extra:8000, colors:["#cfe0ff","#90b7ff","#ffffff","#a6b7d3"] },
  ];

  // ===== حالة الاختيار =====
  let selDesign = null;
  let selFabric = null;
  let selColor  = null;
  let paymentId = null, merchantRef = null;

  // ===== أدوات عامة =====
  function log(msg){ const el=document.getElementById('log'); el.textContent += (msg+"\n"); el.scrollTop=el.scrollHeight; }
  function fmt(n){ return (n||0).toLocaleString("ar-MR"); }
  function $id(id){ return document.getElementById(id); }

  // ===== عرض الطرازات =====
  function renderDesigns(){
    const box = $id("designs"); box.innerHTML="";
    DESIGNS.forEach(d=>{
      const btn=document.createElement("button");
      btn.className="pill";
      btn.innerHTML=`${d.title} — <strong>${fmt(d.price)}</strong>`;
      btn.onclick=()=>{ selDesign=d; updatePills(box, btn); calcTotal(); };
      box.appendChild(btn);
    });
  }
  function updatePills(box, active){
    [...box.children].forEach(el=>el.classList.remove("active"));
    active.classList.add("active");
  }

  // ===== عرض الأقمشة والألوان =====
  function renderFabrics(){
    const box=$id("fabrics"); box.innerHTML="";
    FABRICS.forEach(f=>{
      const wrap=document.createElement("div");
      wrap.className="pill"; wrap.style.display="flex"; wrap.style.gap="10px"; wrap.style.alignItems="center";
      wrap.innerHTML=`${f.name} — <strong>زيادة ${fmt(f.extra)}</strong>`;
      wrap.onclick=()=>{ selFabric=f; [...$id("fabrics").children].forEach(c=>c.classList.remove("active")); wrap.classList.add("active"); calcTotal(); };
      const colors=document.createElement("div"); colors.style.display="flex"; colors.style.gap="8px"; colors.style.marginRight="8px";
      f.colors.forEach(hex=>{
        const dot=document.createElement("div");
        dot.className="color-dot"; dot.style.background=hex;
        dot.onclick=(e)=>{ e.stopPropagation(); selFabric=f; selColor=hex; renderColorActive(); calcTotal(); };
        colors.appendChild(dot);
      });
      wrap.appendChild(colors);
      box.appendChild(wrap);
    });
  }
  function renderColorActive(){
    [...document.querySelectorAll(".color-dot")].forEach(d=>d.classList.remove("active"));
    // مبدئيًا نكتفي بتحديد آخر نقطة ضغطت
    event?.target?.classList?.add("active");
  }

  // ===== حساب المجموع =====
  function calcTotal(){
    const d = selDesign?.price || 0;
    const f = selFabric?.extra || 0;
    const base = 2000; // خياطة أساسية
    const total = d + f + base;
    $id("price-design").textContent = fmt(d);
    $id("price-fabric").textContent = fmt(f);
    $id("price-total").textContent  = fmt(total);
    return total;
  }

  // ===== API =====
  async function createPayment(){
    if(!selDesign){ alert("اختر الطريز أولًا"); return; }
    if(!selFabric){ alert("اختر القماش/اللون"); return; }
    const chest = Number($id("m-chest").value||0);
    const shoulder = Number($id("m-shoulder").value||0);
    const sleeve = Number($id("m-sleeve").value||0);
    const length = Number($id("m-length").value||0);

    const BASE = $id('base').value.trim();
    const provider = $id('provider').value;
    const amountMRU = calcTotal();

    log("POST "+BASE+"/payments/create …");
    const r = await fetch(BASE + "/payments/create", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        orderId: 460003,
        amountMRU,
        provider,
        // تخزين اختيارات العميل (اختياري – للبروتو تايب)
        meta: {
          design: selDesign?.id, fabric: selFabric?.id, color: selColor,
          measurements: { chest, shoulder, sleeve, length }
        }
      })
    });
    const data = await r.json(); log(JSON.stringify(data, null, 2));
    paymentId = data.paymentId; merchantRef = data.merchantRef;
    $id('pid').textContent = paymentId ?? "-";
    $id('mref').textContent = merchantRef ?? "-";
  }

  async function checkStatus(){
    if(!paymentId) return alert("أنشئ عملية أولاً");
    const BASE=$id('base').value.trim();
    log("GET "+BASE+"/payments/"+paymentId+"/status …");
    const r=await fetch(BASE+"/payments/"+paymentId+"/status");
    const data=await r.json(); log(JSON.stringify(data,null,2));
    $id('status').textContent="الحالة: "+(data.status||"-");
  }

  async function simulate(status){
    if(!merchantRef) return alert("أنشئ عملية أولاً");
    const BASE=$id('base').value.trim();
    log("POST "+BASE+"/simulate/webhook …");
    const r=await fetch(BASE+"/simulate/webhook",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ secret:"letmein", provider:$id('provider').value, merchantRef, status })
    });
    const data=await r.json(); log(JSON.stringify(data,null,2));
    await checkStatus();
  }

  // ===== تشغيل أولي =====
  renderDesigns();
  renderFabrics();
  calcTotal();
  </script>
</body>
</html>
